<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./peerjs.1.5.2.min.js"></script>
</head>
<!-- <script src="./main.js"></script> -->
<script>
    // client-side js, loaded by index.html
// run by the browser each time the page is loaded



let messagesEl = document.querySelector('.messages');
// let peerIdEl = document.querySelector('#connect-to-peer');
let videoEl = document.querySelector('.remote-video');


let renderVideo = (stream) => {
//   videoEl.srcObject = stream;
    document.querySelector('video').srcObject = stream;
};

// Register with the peer server
let peer = new Peer({
//   host: '/',
// hostは https://cypress-serious-bird.glitch.me/
// hostは https://cypress-serious-bird.glitch.me/
    // host: 'cypress-serious-bird.glitch.me',
    host: 'cypress-serious-bird.glitch.me',
// https
    secure: true,
  path: '/peerjs/myapp'
});

peer.on('error', (error) => {
  console.error(error);
});

// Handle incoming data connection
// peer.on('connection', (conn) => {
//   logMessage('incoming peer connection!');
//   conn.on('data', (data) => {
//     logMessage(`received: ${data}`);
//   });
//   conn.on('open', () => {
//     conn.send('hello!');
//   });
// });

// Handle incoming voice/video connection
peer.on('call', (call) => {
  navigator.mediaDevices.getUserMedia({video: true, audio: true})
    .then((stream) => {
      call.answer(stream); // Answer the call with an A/V stream.
      call.on('stream', renderVideo);
    })
    .catch((err) => {
      console.error('Failed to get local stream', err);
    });
});

// Initiate outgoing connection
let connectToPeer = () => {
  let peerId = document.querySelector('#connect-to-peer').value;
//   logMessage(`Connecting to ${peerId}...`);
  
  let conn = peer.connect(peerId);
  conn.on('data', (data) => {
    // logMessage(`received: ${data}`);
  });
  conn.on('open', () => {
    conn.send('hi!');
  });
  
  navigator.mediaDevices.getUserMedia({video: true, audio: true})
    .then((stream) => {
      let call = peer.call(peerId, stream);
      call.on('stream', renderVideo);
    })
    .catch((err) => {
    //   logMessage('Failed to get local stream', err);
    });
};
// let logMessage = (message) => {
//   messagesEl.appendChild(newMessage);
// };
peer.on('open', (id) => {
    // resultに受信したデータを表示
    document.querySelector('.result').value = id;
//   logMessage('My peer ID is: ' + id);
});
// connectionを手動で行う関数
function exe_connection(){
    peer.on('connection', (conn) => {
        //   logMessage('incoming peer connection!');
        conn.on('data', (data) => {
            // logMessage(`received: ${data}`);
        });
        // conn.on('open', () => {
        //     conn.send('hello!');
        // });
    });

}
</script>

<body>

    <h1>PeerJS Example</h1>
    <p>サーバーサイドのコードは https://glitch.com/edit/#!/cypress-serious-bird?path=server.js</p>
    <p>参考にしたコードは https://glitch.com/~peerjs-video</p>
    <!-- exe_connection -->
    <!-- <button onclick="exe_connection()">exe_connection</button> -->

    <!-- <p>Open the console to see what's happening.</p> -->
    <p>このURLを2枚のタブで開く。片方に表示されたpeer id Aの英数文字列を、もう片方のタブのPeer ID BのinputにコピペしてConnect Bをクリック</p>
    <!-- <div class="messages"></div> -->
    <!-- peer id A<p class="result"></p> -->
    peer id A<input class="result" type="text">
    <input id="connect-to-peer" type="text" placeholder="Peer ID B">
    <button onclick="connectToPeer()">Connect B</button>
    <video autoplay></video>
</body>
</html>

